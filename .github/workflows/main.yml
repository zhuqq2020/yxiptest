name: Update IP List

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©UTC 8:00
  workflow_dispatch:        # ä¿ç•™æ‰‹åŠ¨è§¦å‘
  push:

jobs:
  update-ip-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    # æ­¥éª¤4ï¼šé…ç½®gitç”¨æˆ·ä¿¡æ¯
    - name: Configure Git
      run: |
        git config --global user.email "tianshideyou@proton.me"
        git config --global user.name "tianshipapa"

    # æ­¥éª¤5ï¼šè¿è¡Œè„šæœ¬
    - name: Run IP collection script
      run: |
        echo "ğŸ”„ å¼€å§‹è¿è¡ŒIPæ”¶é›†è„šæœ¬..."
        python collect_ips.py

    # æ­¥éª¤6ï¼šè°ƒè¯•æ£€æŸ¥
    - name: Check generated files
      run: |
        echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ“ ç›®å½•å†…å®¹:"
        ls -la
        echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰ip.txtæ–‡ä»¶:"
        find . -name "ip.txt" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°ip.txtæ–‡ä»¶"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "ip.txt" ]; then
          echo "âœ… ip.txt æ–‡ä»¶å·²ç”Ÿæˆ"
          echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
          ls -la ip.txt
          echo "ğŸ“ æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -n 5 ip.txt
          echo "ğŸ“ æ€»è¡Œæ•°: $(wc -l < ip.txt)"
        else
          echo "âŒ ip.txt æ–‡ä»¶æœªæ‰¾åˆ°"
          exit 1
        fi

    # æ­¥éª¤7ï¼šæäº¤æ›´æ”¹
    - name: Commit and push changes
      run: |
        echo "ğŸ”„ å‡†å¤‡æäº¤æ›´æ”¹..."
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        git status
        if git diff --exit-code -- ip.txt > /dev/null 2>&1; then
          echo "ğŸ”„ ip.txt å†…å®¹æœªå˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          echo "ğŸ“ æ£€æµ‹åˆ°IPå˜åŒ–ï¼Œå‡†å¤‡æäº¤"
          git add ip.txt
          git commit -m "Auto update IP list - $(date +'%Y-%m-%d %H:%M:%S')"
          git pull origin main --rebase
          git push origin main
          echo "âœ… IPåˆ—è¡¨æ›´æ–°æˆåŠŸ"
        fi
