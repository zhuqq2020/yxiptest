name: Update IP List

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©UTC 8:00
  workflow_dispatch:        # ä¿ç•™æ‰‹åŠ¨è§¦å‘
  push:

jobs:
  update-ip-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    # æ­¥éª¤4ï¼šé…ç½®gitç”¨æˆ·ä¿¡æ¯
    - name: Configure Git
      run: |
        git config --global user.email "tianshideyou@proton.me"
        git config --global user.name "tianshipapa"

    # æ­¥éª¤5ï¼šè¿è¡Œè„šæœ¬
    - name: Run IP collection script
      run: |
        python collect_ips.py

    # æ­¥éª¤6ï¼šæäº¤æ›´æ”¹
    - name: Commit and push changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
        if git diff --quiet -- ip.txt; then
          echo "ğŸ”„ æœªæ£€æµ‹åˆ°IPå˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          echo "ğŸ“ æ£€æµ‹åˆ°IPå˜åŒ–ï¼Œå‡†å¤‡æäº¤"
          git add ip.txt
          git commit -m "Auto update IP list - $(date +'%Y-%m-%d %H:%M:%S')"
          
          # æ‹‰å–æœ€æ–°æ›´æ”¹å¹¶æ¨é€
          git pull origin main --rebase
          git push origin main
          echo "âœ… IPåˆ—è¡¨æ›´æ–°æˆåŠŸ"
        fi
