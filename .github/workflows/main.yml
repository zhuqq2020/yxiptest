name: Update IP List

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©UTC 8:00
  workflow_dispatch:        # ä¿ç•™æ‰‹åŠ¨è§¦å‘
  push:

jobs:
  update-ip-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å†™å…¥æƒé™å¿…é¡»ä¿ç•™

    steps:
    # å…³é”®ä¿®æ”¹ç‚¹1ï¼šå¸¦tokenæ£€å‡º
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # æ³¨å…¥è®¤è¯ä¿¡æ¯
        fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

    # å…³é”®ä¿®æ”¹ç‚¹2ï¼šå…ˆåŒæ­¥æœ€æ–°ä»£ç 
    - name: Pre-sync repository
      run: |
        git config --global user.email "tianshideyou@proton.me"
        git config --global user.name "tianshipapa"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/camel52zhang/yxip.git
        git pull origin main  # æ™®é€šæ‹‰å–æœ€æ–°ä»£ç 

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4

    - name: Run script
      run: python ${{ github.workspace }}/collect_ips.py

    # å…³é”®ä¿®æ”¹ç‚¹3ï¼šæ™ºèƒ½æäº¤é€»è¾‘
    - name: Commit and push changes
      run: |
        # æ£€æµ‹æ–‡ä»¶å˜åŒ–
        if [ -n "$(git status --porcelain -- ip.txt)" ]; then
          git add ip.txt
          git commit -m "Automatic update: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          
          # å¸¦é‡è¯•çš„æ¨é€æœºåˆ¶
          for i in {1..3}; do
            git pull --rebase origin main && break || sleep 5
          done
          
          git push origin HEAD:main
          echo "âœ… æ›´æ–°æ¨é€æˆåŠŸ"
        else
          echo "ğŸ”„ æœªæ£€æµ‹åˆ°IPå˜åŒ–"
        fi
