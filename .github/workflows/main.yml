name: Update IP List

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©UTC 8:00
  workflow_dispatch:        # ä¿ç•™æ‰‹åŠ¨è§¦å‘
  push:

jobs:
  update-ip-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    # æ­¥éª¤4ï¼šé…ç½®gitç”¨æˆ·ä¿¡æ¯
    - name: Configure Git
      run: |
        git config --global user.email "tianshideyou@proton.me"
        git config --global user.name "tianshipapa"

    # æ­¥éª¤5ï¼šè¿è¡Œå‰æ£€æŸ¥ç›®å½•
    - name: Pre-run directory check
      run: |
        echo "ğŸ“ è¿è¡Œå‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ“ è¿è¡Œå‰ç›®å½•å†…å®¹:"
        ls -la
        echo "ğŸ” æ£€æŸ¥ collect_ips.py æ˜¯å¦å­˜åœ¨:"
        if [ -f "collect_ips.py" ]; then
          echo "âœ… collect_ips.py å­˜åœ¨"
          echo "æ–‡ä»¶å¤§å°: $(wc -l < collect_ips.py) è¡Œ"
        else
          echo "âŒ collect_ips.py ä¸å­˜åœ¨"
          exit 1
        fi

    # æ­¥éª¤6ï¼šè¿è¡Œè„šæœ¬
    - name: Run IP collection script
      run: |
        echo "ğŸ”„ å¼€å§‹è¿è¡ŒIPæ”¶é›†è„šæœ¬..."
        # è®¾ç½®æ›´è¯¦ç»†çš„Pythonè¾“å‡º
        python collect_ips.py
        echo "âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ"

    # æ­¥éª¤7ï¼šè¿è¡Œåè¯¦ç»†æ£€æŸ¥
    - name: Post-run detailed check
      run: |
        echo "ğŸ“ è¿è¡Œåå·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ“ è¿è¡Œåå®Œæ•´ç›®å½•å†…å®¹:"
        ls -la
        echo "ğŸ” è¯¦ç»†æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶:"
        find . -type f -name "*.txt" | head -20
        echo "ğŸ“Š æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨æƒ…å†µ:"
        df -h
        echo "ğŸ’¾ æ£€æŸ¥ç£ç›˜inode:"
        df -i

    # æ­¥éª¤8ï¼šä¸“é—¨æ£€æŸ¥ip.txt
    - name: Check ip.txt specifically
      run: |
        echo "ğŸ” ä¸“é—¨æ£€æŸ¥ip.txtæ–‡ä»¶..."
        if [ -f "ip.txt" ]; then
          echo "âœ… ip.txt æ–‡ä»¶å­˜åœ¨"
          echo "ğŸ“Š æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
          ls -la ip.txt
          echo "ğŸ“ æ–‡ä»¶æƒé™: $(stat -c "%A %a %U:%G" ip.txt)"
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $(wc -c < ip.txt) å­—èŠ‚"
          echo "ğŸ“„ æ–‡ä»¶è¡Œæ•°: $(wc -l < ip.txt)"
          echo "ğŸ” æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -n 10 ip.txt
          echo "ğŸ“‹ æœ€åå‡ è¡Œ:"
          tail -n 5 ip.txt
        else
          echo "âŒ ip.txt æ–‡ä»¶ä¸å­˜åœ¨"
          echo "ğŸ” åœ¨æ•´ä¸ªå·¥ä½œåŒºæœç´¢:"
          find $GITHUB_WORKSPACE -name "ip.txt" -type f 2>/dev/null | while read file; do
            echo "æ‰¾åˆ°æ–‡ä»¶: $file"
            ls -la "$file"
          done
          exit 1
        fi

    # æ­¥éª¤9ï¼šæäº¤æ›´æ”¹
    - name: Commit and push changes
      run: |
        echo "ğŸ”„ å‡†å¤‡æäº¤æ›´æ”¹..."
        
        # æ£€æŸ¥gitçŠ¶æ€
        echo "ğŸ“Š GitçŠ¶æ€:"
        git status
        
        # æ£€æŸ¥æ–‡ä»¶å˜åŒ–
        echo "ğŸ“ Gitæ–‡ä»¶å˜åŒ–:"
        git diff --name-status
        
        # æ£€æŸ¥ip.txtæ˜¯å¦æœ‰å®é™…å†…å®¹å˜åŒ–
        if git diff --exit-code ip.txt > /dev/null 2>&1; then
          echo "ğŸ”„ ip.txt å†…å®¹æœªå˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          echo "ğŸ“ æ£€æµ‹åˆ°IPå˜åŒ–ï¼Œå‡†å¤‡æäº¤"
          git add ip.txt
          git status
          git commit -m "Auto update IP list - $(date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main --rebase
          echo "ğŸš€ æ¨é€æ›´æ”¹..."
          git push origin main
          echo "âœ… IPåˆ—è¡¨æ›´æ–°æˆåŠŸ"
        fi
