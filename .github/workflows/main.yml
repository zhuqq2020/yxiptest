name: Update IP List

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©UTC 8:00
  workflow_dispatch:        # ä¿ç•™æ‰‹åŠ¨è§¦å‘
  push:

jobs:
  update-ip-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    # æ­¥éª¤4ï¼šé…ç½®gitç”¨æˆ·ä¿¡æ¯
    - name: Configure Git
      run: |
        git config --global user.email "zhuqq029@qq.com"
        git config --global user.name "zhuqq2020"

    # æ­¥éª¤5ï¼šè¿è¡Œè„šæœ¬
    - name: Run IP collection script
      run: |
        echo "ğŸ”„ å¼€å§‹è¿è¡ŒIPæ”¶é›†è„šæœ¬..."
        python collect_ips.py
        echo "âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ"

    # æ­¥éª¤6ï¼šæ£€æŸ¥æ–‡ä»¶
    - name: Check generated file
      run: |
        if [ -f "ip.txt" ]; then
          echo "âœ… ip.txt æ–‡ä»¶å·²ç”Ÿæˆ"
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $(wc -l < ip.txt) è¡Œ"
          echo "ğŸ“ æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -n 5 ip.txt
        else
          echo "âŒ ip.txt æ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi

    # æ­¥éª¤7ï¼šæäº¤æ›´æ”¹ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
    - name: Commit and push changes
      run: |
        echo "ğŸ”„ å‡†å¤‡æäº¤æ›´æ”¹..."
        
        # æ˜¾ç¤ºgitçŠ¶æ€
        echo "ğŸ“Š GitçŠ¶æ€:"
        git status
        
        # æ˜¾ç¤ºæ–‡ä»¶å†…å®¹ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        echo "ğŸ“„ ip.txt æ–‡ä»¶å†…å®¹:"
        cat ip.txt
        
        # æ·»åŠ æ–‡ä»¶åˆ°gitï¼ˆæ— è®ºæ˜¯å¦å˜åŒ–ï¼‰
        git add ip.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --cached --quiet; then
          echo "ğŸ”„ æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹å˜åŒ–ï¼Œä½†å› ä¸ºæ˜¯é¦–æ¬¡ç”Ÿæˆï¼Œå¼ºåˆ¶åˆ›å»ºæäº¤"
          # å³ä½¿å†…å®¹ç›¸åŒä¹Ÿåˆ›å»ºæäº¤ï¼Œç¡®ä¿æ–‡ä»¶è¢«è·Ÿè¸ª
          git commit -m "Auto update IP list - Initial file - $(date +'%Y-%m-%d %H:%M:%S')" --allow-empty
        else
          echo "ğŸ“ æ£€æµ‹åˆ°IPå˜åŒ–ï¼Œæäº¤æ›´æ”¹"
          git commit -m "Auto update IP list - $(date +'%Y-%m-%d %H:%M:%S')"
        fi
        
        # æ‹‰å–æœ€æ–°ä»£ç å¹¶æ¨é€
        echo "ğŸ” æ‹‰å–æœ€æ–°ä»£ç ..."
        git pull origin main --rebase
        echo "ğŸš€ æ¨é€æ›´æ”¹..."
        git push origin main
        echo "âœ… IPåˆ—è¡¨æ›´æ–°æˆåŠŸ"
